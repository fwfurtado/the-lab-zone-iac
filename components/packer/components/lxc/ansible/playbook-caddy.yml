---
# Playbook para build da imagem LXC com Caddy (Packer)
- hosts: localhost
  become: true
  tasks:
    - name: Install Caddy dependencies
      ansible.builtin.apt:
        name: ["apt-transport-https", "ca-certificates", "curl", "gnupg"]
        state: present
        update_cache: true

    - name: Add Caddy GPG key
      ansible.builtin.get_url:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        dest: /usr/share/keyrings/caddy-stable-archive-keyring.gpg
        mode: "0644"
        force: true

    - name: Add Caddy repository
      ansible.builtin.copy:
        content: |
          deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version
        dest: /etc/apt/sources.list.d/caddy-stable.list
        mode: "0644"

    - name: Install Caddy
      ansible.builtin.apt:
        name: caddy
        state: present
        update_cache: true

    - name: Create directories for Packer files
      ansible.builtin.file:
        path: "{{ item.key | dirname }}"
        state: directory
        mode: "0755"
      loop: "{{ packer_files | default({}) | dict2items }}"

    - name: Write Packer files
      ansible.builtin.copy:
        content: "{{ item.value }}"
        dest: "{{ item.key }}"
        mode: "0644"
      loop: "{{ packer_files | default({}) | dict2items }}"
