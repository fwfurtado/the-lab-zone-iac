# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible-community/ansible-lint/schemas/src/ansiblelint/f/ansible-playbook-schema.json
---
- hosts: localhost
  become: true
  tasks:
    - name: Load extra vars from Packer
      ansible.builtin.include_vars:
        file: /tmp/ansible-extra-vars.json

    # --- Etapa 1: Instalar Tailscale ---
    - name: Add Tailscale signing key
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: "0644"

    - name: Add Tailscale repository
      ansible.builtin.apt_repository:
        repo: >-
          deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg]
          https://pkgs.tailscale.com/stable/debian bookworm main
        filename: tailscale
        state: present

    - name: Install tailscale package
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true

    # --- Etapa 3: IP forwarding ---
    - name: Enable IP forwarding
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: "1"
        sysctl_file: /etc/sysctl.d/99-tailscale.conf
        reload: true
        state: present
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    # --- Etapa 4: Iniciar e autenticar ---
    - name: Enable tailscaled for boot
      ansible.builtin.systemd:
        name: tailscaled
        enabled: true

    - name: Create tailscale runtime directory
      ansible.builtin.file:
        path: /run/tailscale
        state: directory
        mode: "0755"

    - name: Start tailscaled in userspace mode
      ansible.builtin.shell:
        cmd: >-
          nohup tailscaled
          --tun=userspace-networking
          --state=/var/lib/tailscale/tailscaled.state
          --socket=/run/tailscale/tailscaled.sock
          > /tmp/tailscaled.log 2>&1 &

    - name: Wait for tailscaled socket
      ansible.builtin.wait_for:
        path: /run/tailscale/tailscaled.sock
        timeout: 30

    - name: Show tailscaled log on failure
      ansible.builtin.command:
        cmd: cat /tmp/tailscaled.log
      register: tailscaled_log
      failed_when: false
      changed_when: false

    - name: Debug tailscaled log
      ansible.builtin.debug:
        var: tailscaled_log.stdout_lines

    - name: Authenticate and configure Tailscale
      ansible.builtin.command:
        cmd: >-
          tailscale --socket=/run/tailscale/tailscaled.sock up
          --authkey={{ ts_auth_key }}
          --hostname={{ ts_host }}
          --advertise-routes={{ ts_routes }}
