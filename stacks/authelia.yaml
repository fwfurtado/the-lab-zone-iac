# yaml-language-server: $schema=https://atmos.tools/schemas/atmos/atmos-manifest/1.0/atmos-manifest.json

import:
  - catalog/_packer-lxc.yaml
  - catalog/_terraform-lxc.yaml

components:
  packer:
    lxc:
      vars:
        app_name: authelia
        files:
          "/etc/authelia/configuration.yml":
            source: stacks/catalog/lxc/authelia/configuration.yml
            args:
              jwt_secret: !env AUTHELIA_JWT_SECRET
              session_secret: !env AUTHELIA_SESSION_SECRET
              storage_encryption_key: !env AUTHELIA_STORAGE_ENCRYPTION_KEY
          "/etc/authelia/users_database.yml":
            source: stacks/catalog/lxc/authelia/users_database.yml
            args: {}

  terraform:
    lxc:
      component: lxc
      metadata:
        terraform_workspace: "{{ .stack }}"
      vars:
        proxmox_node_name: !env PROXMOX_SSH_NODE_NAME
        proxmox_host: !env PROXMOX_SSH_HOST
        proxmox_ssh_username: !env PROXMOX_SSH_USERNAME
        proxmox_ssh_agent: !env PROXMOX_SSH_AGENT
        template_file: "components/packer/components/lxc/output/authelia-debian-bookworm-template.tar.gz"
        container:
          id: 104
          hostname: "authelia"
          description: "Authelia"
          network:
            ip_cidr: "10.40.1.4/21"
            dns:
              servers: ["1.1.1.1", "1.0.0.1"]
          tags:
            - "core"
            - "{{ .stack }}"
            - "{{ .component }}"
          image:
            repository: "authelia/authelia"
            tag: "latest"
          resources:
            cpu: 1
            memory: 512
            disk:
              size: 5
