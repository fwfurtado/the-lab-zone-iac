# yaml-language-server: $schema=https://atmos.tools/schemas/atmos/atmos-manifest/1.0/atmos-manifest.json

import:
  - catalog/_lxc.yaml
  - catalog/_truenas-app.yaml

components:
  terraform:
    truenas-app:
      component: truenas-app
      metadata:
        terraform_workspace: "{{ .stack }}-truenas"
      vars:
        truenas_ssh_host: !env TRUENAS_SSH_HOST
        truenas_ssh_port: !env TRUENAS_SSH_PORT
        truenas_ssh_username: !env TRUENAS_SSH_USERNAME
        truenas_ssh_host_key_fingerprint: !env TRUENAS_SSH_HOST_KEY_FINGERPRINT
        truenas_ssh_private_key: !env TRUENAS_SSH_PRIVATE_KEY

        app:
          name: "tailscale"
          description: "Tailscale - Self-hosted VPN service"

          compose:
            content: !include.raw stacks/catalog/truenas-app/compose/tailscale.yaml
            vars:
              data_path: "/mnt/paradise/the-lab-zone/stateful-apps/tailscale/data"
              tailscale_image: "tailscale/tailscale"
              tailscale_tag: "v1.92.5"
              ts_authkey: !env TS_AUTHKEY
              ts_routes: "10.40.0.0/21"
              hostname: "tailscale-truenas"

          datasets:
            - path: "tailscale"            
            - path: "tailscale/data"              
    lxc:
      component: lxc
      metadata:
        terraform_workspace: "{{ .stack }}"
      vars:
        proxmox_node_name: !env PROXMOX_SSH_NODE_NAME
        proxmox_host: !env PROXMOX_SSH_HOST
        proxmox_ssh_username: !env PROXMOX_SSH_USERNAME
        proxmox_ssh_agent: !env PROXMOX_SSH_AGENT
        container:
          id: 100
          hostname: "tailscale"
          description: "Tailscale"
          network:
            ip_cidr: "10.40.0.10/21"
          tags:
            - "core"
            - "{{ .stack }}"
            - "{{ .component }}"
          image:
            repository: "tailscale/tailscale"
            tag: "v1.92.5"
          resources:
            cpu: 1
            memory: 1024
            disk:
              size: 5
          entrypoint: "/usr/local/bin/containerboot"
          environment_variables:
            TS_AUTHKEY: !env TS_AUTHKEY
            TS_ROUTES: "10.40.0.0/21"
            TS_STATE_DIR: "/var/tailscale/data"
            TS_HOSTNAME: "tailscale-proxmox"
            PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        extra_pve_conf_lines:
          - "lxc.cgroup2.devices.allow: c 10:200 rwm"
          - "lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file"

