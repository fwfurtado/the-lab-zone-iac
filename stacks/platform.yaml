# yaml-language-server: $schema=https://atmos.tools/schemas/atmos/atmos-manifest/1.0/atmos-manifest.json

import:
  - catalog/_vm.yaml

components:
  terraform:
    talos-cluster:
      metadata:
        terraform_workspace: "{{ .stack }}"
      vars:
        proxmox_node_name: !env PROXMOX_NODE_NAME
        image_registry_username: !env ZOT_K8S_USERNAME
        image_registry_password: !env ZOT_K8S_PASSWORD
        talos_version: "v1.7.5"
        talos_image_platform: "nocloud"
        talos_image_architecture: "amd64"
        talos_image_extensions:
          - "siderolabs/iscsi-tools"
          - "siderolabs/qemu-guest-agent"
        cluster_endpoint: "https://10.40.1.70:6443"
        cluster:
          name: "platform"
          description: "Talos platform cluster"
          tags:
            - "platform"
            - "k8s"
            - "talos"
            - "vm"
        nodes:
          - name: "cp-1"
            id: 200
            role: "controlplane"
            cpu: 4
            memory: 16384
            disk_size: 100
            ip_cidr: "10.40.1.70/21"
          - name: "worker-1"
            id: 201
            role: "worker"
            cpu: 6
            memory: 16384
            disk_size: 100
            ip_cidr: "10.40.1.71/21"
          - name: "worker-2"
            id: 202
            role: "worker"
            cpu: 6
            memory: 16384
            disk_size: 100
            ip_cidr: "10.40.1.72/21"
          - name: "worker-3"
            id: 203
            role: "worker"
            cpu: 6
            memory: 16384
            disk_size: 100
            ip_cidr: "10.40.1.73/21"
        controlplane_config_patches:
          - |
            cluster:
              allowSchedulingOnControlPlanes: true
              network:
                cni:
                  name: none
              proxy:
                disabled: true
